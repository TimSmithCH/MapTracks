var toGeoJSON=function(){"use strict";var t,r=/\s*/g,i=/^\s*|\s*$/g,o=/\s+/;function p(e){if(!e||!e.length)return 0;for(var t=0,r=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t)|0;return r}function D(e,t){return e.getElementsByTagName(t)}function E(e,t){return e.getAttribute(t)}function a(e,t){return parseFloat(E(e,t))}function I(e,t){var r=D(e,t);return r.length?r[0]:null}function g(e){for(var t=0,r=[];t<e.length;t++)r[t]=parseFloat(e[t]);return r}function X(e){var t;return e&&(t=e).normalize&&t.normalize(),e&&e.textContent||""}function y(e,t){var r,n,i={};for(n=0;n<t.length;n++)(r=I(e,t[n]))&&(i[t[n]]=X(r));return i}function m(e,t){for(var r in t)e[r]=t[r]}function J(e){return g(e.replace(r,"").split(","))}function O(e){for(var t=e.replace(i,"").split(o),r=[],n=0;n<t.length;n++)r.push(J(t[n]));return r}function d(e){var t,r=[a(e,"lon"),a(e,"lat")],n=I(e,"ele"),i=I(e,"gpxtpx:hr")||I(e,"hr"),o=I(e,"time");return n&&(t=parseFloat(X(n)),isNaN(t)||r.push(t)),{coordinates:r,time:o?X(o):null,heartRate:i?parseFloat(X(i)):null}}if("undefined"!=typeof XMLSerializer)t=new XMLSerializer;else{var e="object"==typeof process&&!process.browser,n="object"==typeof Titanium;if("object"!=typeof exports||!e&&!n)throw new Error("Unable to initialize serializer");t=new(require("xmldom").XMLSerializer)}function v(e){return void 0!==e.xml?e.xml:t.serializeToString(e)}return{kml:function(e){for(var t={type:"FeatureCollection",features:[]},C={},G={},A={},H=["Polygon","LineString","Point","Track","gx:Track"],r=D(e,"Placemark"),n=D(e,"Style"),i=D(e,"StyleMap"),o=0;o<n.length;o++){var a=p(v(n[o])).toString(16);C["#"+E(n[o],"id")]=a,G[a]=n[o]}for(var s=0;s<i.length;s++){C["#"+E(i[s],"id")]=p(v(i[s])).toString(16);for(var l=D(i[s],"Pair"),u={},f=0;f<l.length;f++)u[X(I(l[f],"key"))]=X(I(l[f],"styleUrl"));A["#"+E(i[s],"id")]=u}for(var h=0;h<r.length;h++)t.features=t.features.concat(c(r[h]));function U(e){var t,r;return"#"===(e=e||"").substr(0,1)&&(e=e.substr(1)),6!==e.length&&3!==e.length||(t=e),8===e.length&&(r=parseInt(e.substr(0,2),16)/255,t="#"+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)),[t,isNaN(r)?void 0:r]}function j(e){var t=D(e,"coord"),r=[],n=[];0===t.length&&(t=D(e,"gx:coord"));for(var i=0;i<t.length;i++)r.push(g(X(t[i]).split(" ")));for(var o=D(e,"when"),a=0;a<o.length;a++)n.push(X(o[a]));return{coords:r,times:n}}function c(e){var t,r=function e(t){var r,n,i,o,a,s=[],l=[];if(I(t,"MultiGeometry"))return e(I(t,"MultiGeometry"));if(I(t,"MultiTrack"))return e(I(t,"MultiTrack"));if(I(t,"gx:MultiTrack"))return e(I(t,"gx:MultiTrack"));for(i=0;i<H.length;i++)if(n=D(t,H[i]))for(o=0;o<n.length;o++)if(r=n[o],"Point"===H[i])s.push({type:"Point",coordinates:J(X(I(r,"coordinates")))});else if("LineString"===H[i])s.push({type:"LineString",coordinates:O(X(I(r,"coordinates")))});else if("Polygon"===H[i]){var u=D(r,"LinearRing"),f=[];for(a=0;a<u.length;a++)f.push(O(X(I(u[a],"coordinates"))));s.push({type:"Polygon",coordinates:f})}else if("Track"===H[i]||"gx:Track"===H[i]){var h=j(r);s.push({type:"LineString",coordinates:h.coords}),h.times.length&&l.push(h.times)}return{geoms:s,coordTimes:l}}(e),n={},i=X(I(e,"name")),o=X(I(e,"address")),a=X(I(e,"styleUrl")),s=X(I(e,"description")),l=I(e,"TimeSpan"),u=I(e,"TimeStamp"),f=I(e,"ExtendedData"),h=I(e,"LineStyle"),c=I(e,"PolyStyle"),p=I(e,"visibility");if(!r.geoms.length)return[];if(i&&(n.name=i),o&&(n.address=o),a){"#"!==a[0]&&(a="#"+a),n.styleUrl=a,C[a]&&(n.styleHash=C[a]),A[a]&&(n.styleMapHash=A[a],n.styleHash=C[A[a].normal]);var g=G[n.styleHash];if(g){h||(h=I(g,"LineStyle")),c||(c=I(g,"PolyStyle"));var y=I(g,"IconStyle");if(y){var m=I(y,"Icon");if(m){var d=X(I(m,"href"));d&&(n.icon=d)}}}}if(s&&(n.description=s),l){var v=X(I(l,"begin")),k=X(I(l,"end"));n.timespan={begin:v,end:k}}if(u&&(n.timestamp=X(I(u,"when"))),h){var S=U(X(I(h,"color"))),T=S[0],b=S[1],x=parseFloat(X(I(h,"width")));T&&(n.stroke=T),isNaN(b)||(n["stroke-opacity"]=b),isNaN(x)||(n["stroke-width"]=x)}if(c){var N=U(X(I(c,"color"))),w=N[0],F=N[1],L=X(I(c,"fill")),M=X(I(c,"outline"));w&&(n.fill=w),isNaN(F)||(n["fill-opacity"]=F),L&&(n["fill-opacity"]="1"===L?n["fill-opacity"]||1:0),M&&(n["stroke-opacity"]="1"===M?n["stroke-opacity"]||1:0)}if(f){var P=D(f,"Data"),R=D(f,"SimpleData");for(t=0;t<P.length;t++)n[P[t].getAttribute("name")]=X(I(P[t],"value"));for(t=0;t<R.length;t++)n[R[t].getAttribute("name")]=X(R[t])}p&&(n.visibility=X(p)),r.coordTimes.length&&(n.coordTimes=1===r.coordTimes.length?r.coordTimes[0]:r.coordTimes);var z={type:"Feature",geometry:1===r.geoms.length?r.geoms[0]:{type:"GeometryCollection",geometries:r.geoms},properties:n};return E(e,"id")&&(z.id=E(e,"id")),[z]}return t},gpx:function(e){var t,r,n=D(e,"trk"),i=D(e,"rte"),o=D(e,"wpt"),a={type:"FeatureCollection",features:[]};for(t=0;t<n.length;t++)(r=s(n[t]))&&a.features.push(r);for(t=0;t<i.length;t++)(r=l(i[t]))&&a.features.push(r);for(t=0;t<o.length;t++)a.features.push(h(o[t]));function u(e,t){for(var r=0;r<t;r++)e.push(null);return e}function f(e,t){var r=D(e,t),n=[],i=[],o=[],a=r.length;if(a<2)return{};for(var s=0;s<a;s++){var l=d(r[s]);n.push(l.coordinates),l.time&&i.push(l.time),(l.heartRate||o.length)&&(o.length||u(o,s),o.push(l.heartRate||null))}return{line:n,times:i,heartRates:o}}function s(e){for(var t,r=D(e,"trkseg"),n=[],i=[],o=[],a=0;a<r.length;a++)if((t=f(r[a],"trkpt"))&&(t.line&&n.push(t.line),t.times&&t.times.length&&i.push(t.times),o.length||t.heartRates&&t.heartRates.length)){if(!o.length)for(var s=0;s<a;s++)o.push(u([],n[s].length));t.heartRates&&t.heartRates.length?o.push(t.heartRates):o.push(u([],t.line.length||0))}if(0!==n.length){var l=p(e);return m(l,c(I(e,"extensions"))),i.length&&(l.coordTimes=1===n.length?i[0]:i),o.length&&(l.heartRates=1===n.length?o[0]:o),{type:"Feature",properties:l,geometry:{type:1===n.length?"LineString":"MultiLineString",coordinates:1===n.length?n[0]:n}}}}function l(e){var t=f(e,"rtept");if(t.line){var r=p(e);return m(r,c(I(e,"extensions"))),{type:"Feature",properties:r,geometry:{type:"LineString",coordinates:t.line}}}}function h(e){var t=p(e);return m(t,y(e,["sym"])),{type:"Feature",properties:t,geometry:{type:"Point",coordinates:d(e).coordinates}}}function c(e){var t={};if(e){var r=I(e,"line");if(r){var n=X(I(r,"color")),i=parseFloat(X(I(r,"opacity"))),o=parseFloat(X(I(r,"width")));n&&(t.stroke=n),isNaN(i)||(t["stroke-opacity"]=i),isNaN(o)||(t["stroke-width"]=96*o/25.4)}}return t}function p(e){var t=y(e,["name","cmt","desc","type","time","keywords"]),r=D(e,"link");r.length&&(t.links=[]);for(var n,i=0;i<r.length;i++)m(n={href:E(r[i],"href")},y(r[i],["text","type"])),t.links.push(n);return t}return a}}}();"undefined"!=typeof module&&(module.exports=toGeoJSON);