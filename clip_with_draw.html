<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TrackMap</title>
    <meta name="description" content="TrackMap">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <!-- External libraries -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script src='https://d3js.org/d3.v3.min.js' charset='utf-8'></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <!-- script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css' type='text/css'/>
    <!-- Site styles -->
    <link rel="stylesheet" href="css/trackmap.css">
  </head>

  <body class="wrapper">

    <!-- Menu usage based on: https://www.mapbox.com/mapbox-gl-js/example/toggle-layers/ -->
    <!-- Navigation control based on: https://www.mapbox.com/mapbox-gl-js/example/navigation/ -->
    <!-- Popups based on: https://www.mapbox.com/mapbox-gl-js/example/popup-on-hover/ -->
    <!-- Zoom to feature based on: https://www.mapbox.com/mapbox-gl-js/example/zoomto-linestring/ -->
    <header class="header">
      Track Editor
    </header>
    <main class="main">
      <div id='map' class="main-content">
        <nav id="menu"></nav>
      </div>

      <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoidGltc21pdGhjaCIsImEiOiJjaW5vamRodXowMGNtdzJrbGloNjRuMHk1In0.IBVnTC9U9dAvRc1DVjIgkA';
            var map = new mapboxgl.Map({
              container: 'map', // container id
              style: 'mapbox://styles/mapbox/outdoors-v10', //stylesheet location
              center: [7.2989238, 46.032874], // starting position
              zoom: 11 // starting zoom
            });
            
            // Add zoom, rotation and full_screen controls to the map
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.FullscreenControl());

            //
            var draw = new MapboxDraw({
                displayControlsDefault: false,
                controls: {
                    line_string: true,
                    //polygon: true,
                    trash: true,
                    //point: true,
                    combine_features: true
                    //uncombine_features: true
                }
            });
            map.addControl(draw, 'top-left');

            // Hardcode for now, read input later
            var tracktype = "ski";
            var trackname = "AAZ.geojson";
            var datafile = "tracks/geojson/" + tracktype + "/" + trackname

            map.on('load', function () {
            // Fetch JSON using D3 so can parse and use separately from GL JS
                d3.json(datafile, function(err, data) {
                    if (err) throw err;

                    // save full coordinate list for later
                    var coordinates = data.features[0].geometry.coordinates;
                    var good_coordinates = coordinates;

                    // Use Turf to convert all the LineString points into individual points
//                    var point_data = turf.explode(data.features[0]);
//                    var polygon = turf.polygon(coordinates);
//                    var polygon = turf.lineToPolygon(data.features[0]);
                    var line = turf.lineString(data.features[0].geometry.coordinates);
                    var id = draw.add(line);
                    // draw.select(id);
                    draw.changeMode('direct_select',{featureId:id});

                    // Zoom to fit track in screen
                    var bounds = coordinates.reduce(function(bounds, coord) {
                        return bounds.extend(coord);
                    }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
                    map.fitBounds(bounds, {
                        padding: 20
                    });

                    //
                    map.on('draw.update', e => {
                      console.log("Updated: " + e.features[0].geometry.coordinates);
                    });

                    //
                    map.on('draw.combine', e => {
                      console.log("Combined: " + e.features[0].geometry.coordinates);
                    });

                    //
                    map.on('draw.delete', e => {
                      console.log("Trashed: " + e.features[0].geometry.coordinates);
                    });

//        if (data.features.length > 0) {
//            // Stringify the GeoJson
//            var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));
//            // Create export
//            document.getElementById('export').setAttribute('href', 'data:' + convertedData);
//            document.getElementById('export').setAttribute('download','data.geojson');    
//        } else {
//            alert("Wouldn't you like to draw some data?");
//        }


                });
            });
      </script>
    </main>

    <footer class="footer">
        TrackMap: &copy; Tim Smith CC-BY-4.0
    </footer>
  </body>
</html>
