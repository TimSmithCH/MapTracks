<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TrackMap</title>
    <meta name="description" content="TrackMap">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet'>
    <!-- Site styles and icons -->
    <link rel="stylesheet" href="css/trackmap.css">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/vnd.microsoft.icon" href="images/favicon.ico">
  </head>

  <body class="wrapper">
    <!-- Menu usage based on: https://www.mapbox.com/mapbox-gl-js/example/toggle-layers/ -->
    <!-- Navigation control based on: https://www.mapbox.com/mapbox-gl-js/example/navigation/ -->
    <!-- Popups based on: https://www.mapbox.com/mapbox-gl-js/example/popup-on-hover/ -->
    <!-- Zoom to feature based on: https://www.mapbox.com/mapbox-gl-js/example/zoomto-linestring/ -->
    <main class="main">
      <div id='map' class="main-content">
        <nav id="menu"></nav>
      </div>

      <script>
            // Parse arguements pased on URL
            const urlSearchParams = new URLSearchParams(window.location.search);
            var z = urlSearchParams.get('zoom');
            if (!z) {
              var zoomlvl = 11;
            } else {
              console.log("Set Zoom: ",z);
            }
            var la = urlSearchParams.get('lat');
            if (!la) {
              la = 46.032874;
            } else {
              console.log("Set centre Latitude: ",la);
            }
            var lo = urlSearchParams.get('lon');
            if (!lo) {
              lo = 7.2989238;
            } else {
              console.log("Set centre Longitude: ",lo);
            }

            // Prepare layer properties object
            var layer_props = { tracks_hike:    { source_layer: "hike_tracks",    source: "tileset", colour: "#FF2020" },
                                tracks_bike:    { source_layer: "bike_tracks",    source: "tileset", colour: "#12B812" },
                                tracks_ski:     { source_layer: "ski_tracks",     source: "tileset", colour: "#0048FF" },
                                tracks_run:     { source_layer: "run_tracks",     source: "tileset", colour: "#B10DC9" },
                                tracks_commute: { source_layer: "commute_tracks", source: "tileset", colour: "#006400" },
                                tracks_vehicle: { source_layer: "vehicle_tracks", source: "geojson", colour: "#F39C12" },
                                tracks_wip:     { source_layer: "wip_tracks",     source: "geojson", colour: "#F3DB12" } };

            
            // Prepare the Mapbox object
            mapboxgl.accessToken = 'pk.eyJ1IjoidGltc21pdGhjaCIsImEiOiJjaW5vamRodXowMGNtdzJrbGloNjRuMHk1In0.IBVnTC9U9dAvRc1DVjIgkA';
            var map = new mapboxgl.Map({
              container: 'map', // container id
              style: 'mapbox://styles/mapbox/outdoors-v11', //stylesheet location
              //center: [7.2989238, 46.032874], // starting position
              center: [lo, la], // starting position
              zoom: zoomlvl // starting zoom
            });

            // Add zoom, rotation and full_screen controls to the map
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.FullscreenControl());

            // Add GeoLocation control to the map (disabled if not served over https)
            if (window.isSecureContext) {
                map.addControl(new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true
                }));
            } else {
                console.log("Cant use geolocation when served over http!");
            }

            // Add overlay data layers on demand (after load or style change)
            var dimension = 2;
            var basechange = 0;
            function addDataLayers() {
              basechange = 0
              // For 3D add terrain and sky
              if (dimension == 3) {
                map.addSource('mapbox-dem', {
                    'type': 'raster-dem',
                    'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                    'tileSize': 512,
                    'maxzoom': 14
                });
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.2 });
                map.addLayer({
                    'id': 'sky',
                    'type': 'sky',
                    'paint': {
                        'sky-type': 'atmosphere',
                        'sky-atmosphere-sun': [0.0, 90.0],
                        'sky-atmosphere-sun-intensity': 15
                    }
                });
              // For 2D make contour labels easier to read
              } else {
                map.setLayoutProperty('contour-label', 'text-size', [
                  "interpolate", ["linear"], ["zoom"],
                  1, 0,
                  12, 12,
                  20, 24,
                ]);
              }

              //----------------------------------------------
              // Add Swiss cantons
              map.addSource("cantons", {
                type: 'vector',
                url: 'mapbox://timsmithch.swiss_cantons'
              });
              map.addLayer({
                "id": "cantons",
                "type": "fill",
                "source": "cantons",
                'source-layer': 'swiss_cantons',
                "layout": {
                  "visibility": "none"
                },
                "paint": {
                  'fill-opacity': 0.25,
                  'fill-color': [ 'match', ['get', 'KANTONSNUM'],
                    1, '#00ff00',
                    2, '#00ff00',
                    3, '#ffa500',
                    4, '#ff0000',
                    5, '#800080',
                    6, '#0000ff',
                    7, '#ffff00',
                    8, '#00ff00',
                    9, '#ffff00',
                    10, '#ffa500',
                    11, '#800080',
                    12, '#ffa500',
                    13, '#ffff00',
                    14, '#800080',
                    15, '#ffff00',
                    16, '#800080',
                    17, '#ffa500',
                    18, '#ffff00',
                    19, '#ff0000',
                    20, '#0000ff',
                    21, '#800080',
                    22, '#ffff00',
                    23, '#0000ff',
                    24, '#ff0000',
                    25, '#800080',
                    26, '#0000ff',
                    /* other */ '#ccc'
                  ]
                }
              });

              //----------------------------------------------
              // Add Swiss mountains:
              //  0-3000m with prominence >300m https://en.wikipedia.org/wiki/List_of_mountains_of_Switzerland
              //  3000-4000m with prominence >150m https://en.wikipedia.org/wiki/List_of_mountains_of_Switzerland_above_3000_m
              //  4000-5000m with prominence >30m https://en.wikipedia.org/wiki/List_of_Alpine_four-thousanders
              map.addSource("mountainsH", {
                "type": "geojson",
                "data": "features/CH_Mountains_H3000_P300.json"
              });
              map.addLayer({
                "id": "mountainsH",
                "type": "circle",
                "source": "mountainsH",
                "layout": {
                  "visibility": "none",
                },
                "paint": {
                  // make circles larger as the user zooms from z12 to z22
                  "circle-radius": {
                    "base": 3.00,
                    "stops": [[12, 8], [22, 720]]
                  },
                  // color circles by height
                  "circle-color": [ "step", ["get", "height"],
                      "#df80ff",
                      3000, "#cc00cc",
                      4000, "#600080"
                  ]
                },
                "filter": ["==", ["geometry-type"], "Point"]
              });

              //----------------------------------------------
              // Add Alpine 4000er mountains:
              //  4000-5000m https://en.wikipedia.org/wiki/List_of_Alpine_four-thousanders
              map.addSource("mountainsE", {
                "type": "geojson",
                "data": "features/EU_Mountains_H4000.json"
              });
              map.addLayer({
                "id": "mountainsE",
                "type": "circle",
                "source": "mountainsE",
                "layout": {
                  "visibility": "none",
                },
                "paint": {
                  // make circles larger as the user zooms from z12 to z22
                  "circle-radius": {
                    "base": 3.00,
                    "stops": [[12, 8], [22, 720]]
                  },
                  // color circles by height
                  "circle-color": [ "step", ["get", "height"],
                      "#dd00ff",
                      4200, "#cc00ff",
                      4400, "#bb00ff"
                  ]
                },
                "filter": ["==", ["geometry-type"], "Point"]
              });

              //----------------------------------------------
              // EITHER Create a layer of routes of each type from layers in MapBox tileset
              map.addSource('tracks-all', {
                type: 'vector',
                url: 'mapbox://timsmithch.all_tracks'
              });
              for (let layer of Object.keys(layer_props)) {
                if (layer_props[layer]["source"] === "tileset") {
                  map.addLayer({
                    'id': layer,
                    'type': 'line',
                    'source': 'tracks-all',
                    "source-layer": layer_props[layer]["source_layer"],
                    "layout": {
                      "visibility": "visible",
                      "line-join": "round",
                      "line-cap": "round"
                    },
                    "paint": {
                      "line-color": layer_props[layer]["colour"],
                      "line-width": [ 'interpolate', ['exponential', 2], ['zoom'],
                         0, ["^", 2, 3],
                         8, ["^", 2, 1],
                         24, ["^", 2, 8]
                       ],
                      //"line-opacity": ["case",["has","desc"],["to-number",["get","desc"]],1.0]
                      "line-dasharray": ["match", ["get", "desc"], ["0.5" ], ["literal", [2, 2]], ["literal", [1]]]
                    }
                  });
                }
              }
              // Option 1: change dash style, but currently not supported by MapBox as a data-driven style
              //      "line-dasharray": [2, 1],
              // Option 2: change colour using data-driven style, but probably makes too colorful-messy!
              //      "line-color": ["case",["has","description"],["get","description"],layer_props[layer]["colour"],

              //----------------------------------------------
              // OR Create a layer of routes of each type from geojson files
              for (let layer of Object.keys(layer_props)) {
                if (layer_props[layer]["source"] === "geojson") {
                  map.addSource(layer, {
                    type: 'geojson',
                    "data": "tracks/1_display/" + layer_props[layer]["source_layer"] + ".geojson"
                  });
                  map.addLayer({
                    'id': layer,
                    'type': 'line',
                    'source': layer,
                    "layout": {
                      "visibility": "visible",
                      "line-join": "round",
                      "line-cap": "round"
                    },
                      "paint": {
                      "line-color": layer_props[layer]["colour"],
                      "line-width": 2
                    }
                  });
                  map.addLayer({
                    'id': layer + "-points",
                    'type': 'symbol',
                    'source': layer,
                    "minzoom": 6,
                    "layout": {
                      "visibility": "visible",
                      "icon-image": "{desc}-15",   // Data-driven styling //
                      "icon-allow-overlap": true,   // Allow collisions //
                      "text-field": "{name}",   // Data-driven styling //
                      "text-allow-overlap": true,   // Allow collisions //
                      "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
                      "text-offset": [0, 0.6],
                      "text-anchor": "top",
                      "text-size": [ 'interpolate', ['exponential', 2], ['zoom'], 6,6,10,15 ]
                    },
                    "filter": ["==", ["geometry-type"], "Point"]
                  });
                }
              }
            }

            map.on('styledata', function () {
              //console.log("ON StyleData",basechange);
              // Triggered when `setStyle` is called, to enable 2D/3D switching
              if (basechange == 1) {
                addDataLayers();
              }
            });

            map.on('load', function () {
              //console.log("ON Load");
              addDataLayers();
            });

            //----------------------------------------------
            // Create a popup, but don't add it to the map yet
            var popup = new mapboxgl.Popup({
              closeButton: false,
              closeOnClick: false
            });

            // Loop creating popup on hover for each layer
            for (let layer of Object.keys(layer_props)) {
              map.on('mouseenter', layer, function(e) {
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';
                // Populate the popup and set its coordinates based on the feature found.
                var date = e.features[0].properties.cmt
                popup.setLngLat(e.lngLat)
                    //.setHTML('<strong>' + e.features[0].properties.name +'</strong>')
                    .setHTML('<strong>' + e.features[0].properties.name +'</strong><br>' + date)
                    .addTo(map);
              });
              map.on('mouseleave', layer, function() {
                map.getCanvas().style.cursor = '';
                popup.remove();
              });
            }

            // Create popup on hover for CH mountains
            map.on('mouseenter', "mountainsH", function(e) {
              // Change the cursor style as a UI indicator
              map.getCanvas().style.cursor = 'pointer';
              // Populate the popup and set its coordinates based on the feature found
              var height = e.features[0].properties.height
              popup.setLngLat(e.lngLat)
                .setHTML('<strong>' + e.features[0].properties.name +'</strong><br>' + height)
                  .addTo(map);
            });
            map.on('mouseleave', "mountainsH", function() {
              map.getCanvas().style.cursor = '';
              popup.remove();
            });

            // Create popup on hover for EU mountains
            map.on('mouseenter', "mountainsE", function(e) {
              // Change the cursor style as a UI indicator
              map.getCanvas().style.cursor = 'pointer';
              // Populate the popup and set its coordinates based on the feature found
              var height = e.features[0].properties.height
              popup.setLngLat(e.lngLat)
                .setHTML('<strong>' + e.features[0].properties.name +'</strong><br>' + height)
                  .addTo(map);
            });
            map.on('mouseleave', "mountainsE", function() {
              map.getCanvas().style.cursor = '';
              popup.remove();
            });

            //----------------------------------------------
            // Create the menu buttons and add click actions
            toggleLayer("Hike", "tracks_hike", "active");
            toggleLayer("Bike", "tracks_bike", "active");
            toggleLayer("Ski", "tracks_ski", "active");
            toggleLayer("Run", "tracks_run", "active");
            toggleLayer("Cmute", "tracks_commute", "active");
            toggleLayer("Mech", "tracks_vehicle", "active");
            toggleLayer("Canton", "cantons", "");
            toggleLayer("4000s", "mountainsE", "");
            toggleLayer("Peaks", "mountainsH", "");
            function toggleLayer(name, id, state) {
              var link = document.createElement('a');
              link.href = '#';
              link.className = state;
              link.textContent = name;
              link.id = name;
              link.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                var idmark = id + "-points"
                var visibility = map.getLayoutProperty(id, 'visibility');
                if (visibility === 'visible') {
                  map.setLayoutProperty(id, 'visibility', 'none');
                  map.setLayoutProperty(idmark, 'visibility', 'none');
                  this.className = '';
                  if (name === 'Peaks') {
                    var s1 = document.getElementById('sliders');
                    s1.style.display = "none";
                    var o1 = document.getElementById('outH');
                    o1.style.display = "none";
                    var o2 = document.getElementById('outP');
                    o2.style.display = "none";
                  }
                } else {
                  this.className = 'active';
                  map.setLayoutProperty(id, 'visibility', 'visible');
                  map.setLayoutProperty(idmark, 'visibility', 'visible');
                  if (name === 'Peaks') {
                    var s1 = document.getElementById('sliders');
                    s1.style.display = "block";
                    var o1 = document.getElementById('outH');
                    o1.style.display = "block";
                    var o2 = document.getElementById('outP');
                    o2.style.display = "block";
                  }
                }
              };
              var layers = document.getElementById('menu');
              layers.appendChild(link);
            }

            //----------------------------------------------
            // Create the slider and add change actions
            var div = document.createElement("div");
            div.id = "sliders";
            div.style.display = "none";
            var sliderH = document.createElement('input');
            sliderH.setAttribute('type', 'range');
            sliderH.setAttribute('min', '0');
            sliderH.setAttribute('max', '4000');
            sliderH.setAttribute('step', '250');
            sliderH.setAttribute('value', '0');
            sliderH.setAttribute('orient', 'vertical');
            var sliderP = document.createElement('input');
            sliderP.setAttribute('class', 'right');
            sliderP.setAttribute('type', 'range');
            sliderP.setAttribute('min', '0');
            sliderP.setAttribute('max', '500');
            sliderP.setAttribute('step', '50');
            sliderP.setAttribute('value', '0');
            sliderP.setAttribute('orient', 'vertical');
            div.appendChild(sliderH);
            div.appendChild(sliderP);
            var menus = document.getElementById('menu');
            menus.appendChild(div);
            // Listen for change of slider event and update the map
            sliderH.addEventListener('input', function(e) {
              var height_value = parseInt(e.target.value);
              var prominence_value = Number(sliderP.value);
              var mountFilter = ["all",
                ['>=', ['number', ['get', 'height']], height_value],
                ['>=', ['number', ['get', 'prominence']], prominence_value]];
              map.setFilter('mountainsH', mountFilter);
            });
            sliderP.addEventListener('input', function(e) {
              var prominence_value = parseInt(e.target.value);
              var height_value = Number(sliderH.value);
              var mountFilter = ["all",
                ['>=', ['number', ['get', 'height']], height_value],
                ['>=', ['number', ['get', 'prominence']], prominence_value]];
              map.setFilter('mountainsH', mountFilter);
            });

            //----------------------------------------------
            // Create the slider output display
            var slideoutH = document.createElement('output');
            slideoutH.id = "outH";
            slideoutH.style.display = "none";
            slideoutH.setAttribute('for', 'value');
            slideoutH.innerHTML = 0;
            var slideoutP = document.createElement('output');
            slideoutP.id = "outP";
            slideoutP.style.display = "none";
            slideoutP.setAttribute('for', 'value');
            slideoutP.setAttribute('class', 'right');
            slideoutP.innerHTML = 0;
            var menus = document.getElementById('menu');
            menus.appendChild(slideoutH);
            sliderH.oninput = function() {
              slideoutH.innerHTML = this.value;
            }
            menus.appendChild(slideoutP);
            sliderP.oninput = function() {
              slideoutP.innerHTML = this.value;
            }

            //----------------------------------------------
            // Create a zoom level indcator
            var zoomout = document.createElement('output');
            zoomout.id = "zoomO";
            zoomout.style.display = "block";
            zoomout.setAttribute('for', 'value');
            zoomout.innerHTML = zoomlvl;
            menus.appendChild(zoomout);
            map.on('zoom', function() {
              zoomout.innerHTML = parseFloat(map.getZoom()).toFixed(2);
            });

            //----------------------------------------------
            // Create 2D/3D toggle button
            var dimtog = document.createElement('button');
            dimtog.textContent = '3D';
            dimtog.style.backgroundColor ='orange';
            dimtog.style.color ='white';
            dimtog.style.outline ='none';
            dimtog.style.display = "block";
            dimtog.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              if (dimension === 2) {
                dimtog.textContent = '2D';
                map.setStyle('mapbox://styles/mapbox-map-design/ckhqrf2tz0dt119ny6azh975y');
                map.setPitch(65)
                map.setBearing(-45)
                dimension = 3
              } else {
                dimtog.textContent = '3D';
                map.setStyle('mapbox://styles/mapbox/outdoors-v11');
                map.setPitch(0)
                map.setBearing(0)
                dimension = 2
              }
              basechange = 1
            };
            menus.appendChild(dimtog);

            //----------------------------------------------
            // Create the close/open toggle button for menus
            var closer = document.createElement('button');
            closer.textContent = 'Close';
            closer.style.backgroundColor ='red';
            closer.style.color ='white';
            closer.style.outline ='none';
            closer.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              var m = document.querySelectorAll('a,#zoomO');
              for (var i = 0; i < m.length; i++) {
                var mChild = m[i];
                if (mChild.style.display === "none") {
                  mChild.style.display = "block";
                  closer.style.backgroundColor ='red';
                  closer.textContent = 'Close';
                  if (mChild.id === 'Peaks' && mChild.className === 'active') {
                    var s1 = document.getElementById('sliders');
                    s1.style.display = "block";
                    var o1 = document.getElementById('outH');
                    o1.style.display = "block";
                    var o2 = document.getElementById('outP');
                    o2.style.display = "block";
                  }
                } else {
                  mChild.style.display = "none";
                  closer.style.backgroundColor ='green';
                  closer.textContent = 'Menu';
                  if (mChild.id === 'Peaks' && mChild.className === 'active') {
                    var s1 = document.getElementById('sliders');
                    s1.style.display = "none";
                    var o1 = document.getElementById('outH');
                    o1.style.display = "none";
                    var o2 = document.getElementById('outP');
                    o2.style.display = "none";
                  }
                }
              }
            };
            menus.appendChild(closer);

      </script>
    </main>

    <footer class="footer">
        TrackMap: &copy; Tim Smith CC-BY-4.0
    </footer>
  </body>
</html>
