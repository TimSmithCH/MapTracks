<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TrackMap</title>
    <meta name="description" content="TrackMap">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.0/mapbox-gl.css' rel='stylesheet' 
    <!-- External libraries -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <!-- Site styles -->
    <link rel="stylesheet" href="css/trackmap.css">
  </head>

  <body class="wrapper">
<style>
input[type=range] {
  -webkit-appearance: none; /* Hides the slider so that custom slider can be made */
  width: 100%; /* Specific width is required for Firefox. */
  background: transparent; /* Otherwise white in Chrome */
}
</style>
    <!-- Menu usage based on: https://www.mapbox.com/mapbox-gl-js/example/toggle-layers/ -->
    <!-- Navigation control based on: https://www.mapbox.com/mapbox-gl-js/example/navigation/ -->
    <!-- Popups based on: https://www.mapbox.com/mapbox-gl-js/example/popup-on-hover/ -->
    <!-- Zoom to feature based on: https://www.mapbox.com/mapbox-gl-js/example/zoomto-linestring/ -->
    <header class="header">
      Track Collections Mapped
    </header>
    <main class="main">
      <div id='map' class="main-content">
        <nav id="menu"></nav>
      </div>

      <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoidGltc21pdGhjaCIsImEiOiJjaW5vamRodXowMGNtdzJrbGloNjRuMHk1In0.IBVnTC9U9dAvRc1DVjIgkA';
            var map = new mapboxgl.Map({
              container: 'map', // container id
              style: 'mapbox://styles/mapbox/outdoors-v10', //stylesheet location
              center: [7.2989238, 46.032874], // starting position
              zoom: 11 // starting zoom
            });
            
            // Add zoom, rotation and full_screen controls to the map
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.FullscreenControl());

            // Prepare layer properties object
            var layer_props = { hike_routes: { datafile: "Overview_hike.geojson", colour: "red" },
                                bike_routes: { datafile: "Overview_bike.geojson", colour: "green" },
                                 ski_routes: { datafile: "Overview_ski.geojson",  colour: "blue" },
                                 run_routes: { datafile: "Overview_run.geojson",  colour: "purple" } };

            map.on('load', function () {
              // Add Swiss cantons
              map.addSource("cantons", {
                "type": "geojson",
                "data": "tracks/geojson/ch-cantons.json"
              });
              map.addLayer({
                "id": "cantons",
                "type": "fill",
                "source": "cantons",
                "layout": {
                  "visibility": "none"
                },
                "paint": {
                  'fill-opacity': 0.25,
                  'fill-color': [ 'match', ['get', 'KANTONSNUM'],
                    1, '#00ff00',
                    2, '#00ff00',
                    3, '#ffa500',
                    4, '#ff0000',
                    5, '#800080',
                    6, '#0000ff',
                    7, '#ffff00',
                    8, '#00ff00',
                    9, '#ffff00',
                    10, '#ffa500',
                    11, '#800080',
                    12, '#ffa500',
                    13, '#ffff00',
                    14, '#800080',
                    15, '#ffff00',
                    16, '#800080',
                    17, '#ffa500',
                    18, '#ffff00',
                    19, '#ff0000',
                    20, '#0000ff',
                    21, '#800080',
                    22, '#ffff00',
                    23, '#0000ff',
                    24, '#ff0000',
                    25, '#800080',
                    26, '#0000ff',
                    /* other */ '#ccc'
                  ]
                }
              });
              // Add Markers for important waypoints on trips
              map.addSource("markers", {
                "type": "geojson",
                "data": "tracks/geojson/track_markers.json"
              });
              map.addLayer({
                "id": "markers",
                "type": "symbol",
                "source": "markers",
                "layout": {
                  "visibility": "none",
                  "icon-image": "{icon}-15",   // Data-driven styling //
                  "text-field": "{name}",   // Data-driven styling //
                  "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
                  "text-offset": [0, 0.6],
                  "text-anchor": "top"
                },
                "filter": ["==", ["geometry-type"], "Point"]
              });
              //
              // Add Swiss mountains above 3000m
              map.addSource("mountainsH", {
                "type": "geojson",
                "data": "tracks/geojson/CH_Mountains_H3000.json"
              });
              map.addLayer({
                "id": "mountainsH",
                "type": "circle",
                "source": "mountainsH",
                "layout": {
                  "visibility": "none",
                },
                "paint": {
                  // make circles larger as the user zooms from z12 to z22
                  "circle-radius": {
                    "base": 3.00,
                    "stops": [[12, 8], [22, 720]]
                  },
                  // color circles by height
                  "circle-color": [ "step", ["get", "height"],
                      "#cc00ff",
                      3000, "#cc00cc",
                      4000, "#600080"
                  ]
                },
                "filter": ["==", ["geometry-type"], "Point"]
              });
              //
              // Add Swiss mountains with 300m prominence and above
              map.addSource("mountainsP", {
                "type": "geojson",
                "data": "tracks/geojson/CH_Mountains_P300.json"
              });
              map.addLayer({
                "id": "mountainsP",
                "type": "circle",
                "source": "mountainsP",
                "layout": {
                  "visibility": "none",
                },
                "paint": {
                  // color circles by height
                  "circle-color": [ "step", ["get", "height"],
                      "#df80ff",
                      3000, "#bf00ff",
                      4000, "#600080"
                  ],
                  "circle-radius": [
                    'interpolate', ['linear'], ['zoom'],
                    12, 8,
                    22, 720
                  ]
                },
                "filter": ["==", ["geometry-type"], "Point"]
              });
              //
              // Loop creating a layer of routes of each type from geojson file
              for (let layer of Object.keys(layer_props)) {
                map.addSource(layer, {
                  "type": "geojson",
                  "data": "tracks/geojson/" + layer_props[layer]["datafile"]
                });
                map.addLayer({
                  "id": layer,
                  "type": "line",
                  "source": layer,
                  "layout": {
                    "visibility": "visible",
                    "line-join": "round",
                    "line-cap": "round"
                  },
                  "paint": {
                    "line-color": layer_props[layer]["colour"],
                    "line-width": 4
                  }
                });
              }
            });

            // Create a popup, but don't add it to the map yet
            var popup = new mapboxgl.Popup({
              closeButton: false,
              closeOnClick: false
            });

            // Loop creating popup on hover for each layer
            for (let layer of Object.keys(layer_props)) {
              map.on('mouseenter', layer, function(e) {
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';
                // Populate the popup and set its coordinates based on the feature found.
                var date = e.features[0].properties.time.split('T',1)
                popup.setLngLat(e.lngLat)
                    .setHTML('<strong>' + e.features[0].properties.name +'</strong><br>' + date)
                    .addTo(map);
              });
              map.on('mouseleave', layer, function() {
                map.getCanvas().style.cursor = '';
                popup.remove();
              });
            }

            // Create the handler to display detailed route when clicked
            map.on('click', function(e) {
              var features = map.queryRenderedFeatures(e.point, { layers: Object.keys(layer_props),
                                                                  filter: ["==", "$type", "LineString"] });
              // If didnt click on a LineString then feature list will be empty
              if (features.length == 0) return;
              // Zoom to fit clicked track in screen
              var coordinates = features[0].geometry.coordinates;
              var bounds = coordinates.reduce(function(bounds, coord) {
                return bounds.extend(coord);
              }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[0]));
              map.fitBounds(bounds, {
                padding: 20
              });
              // Load detailed coordinates of clicked track
              var trackname = features[0].properties.name +'.geojson';
              // Replace space dash space with underscore in filenames
              trackname = trackname.replace(/ - /g, "_");
              // Replace spaces and apostrophes with underscore in filenames
              trackname = trackname.replace(/ |\u2019/g, "_");
              var layerid = features[0].layer.id;
              layerid = layerid.replace(/_routes/g, "");
              var layername = "detail_" + trackname;
              // Remove any previous detail layer of same name
              if (map.getLayer(layername)) {
                map.removeSource(layername);
                map.removeLayer(layername);
              }
              map.addSource(layername, {
                "type": "geojson",
                "data": "tracks/geojson/" + layerid + "/" + trackname
              });
              map.addLayer({
                "id": layername,
                "type": "line",
                "source": layername,
                "layout": {
                  "visibility": "visible",
                  "line-join": "round",
                  "line-cap": "round"
                },
                "paint": {
                  "line-color": "orange",
                  "line-width": 4
                }
              });
              // Toggle the routes layer by simulating a mouse click
              if (layerid == 'hike') {
                document.getElementById('Hike').click();
              } else if (layerid == 'bikes') {
                document.getElementById('Bike').click();
              } else if (layerid == 'ski') {
                document.getElementById('Ski').click();
              } else if (layerid == 'run') {
                document.getElementById('Run').click();
              }
            });

            //----------------------------------------------
            // Create the menu buttons and add click actions
            toggleLayer("Hike", "hike_routes", "active");
            toggleLayer("Bike", "bike_routes", "active");
            toggleLayer("Ski", "ski_routes", "active");
            toggleLayer("Run", "run_routes", "active");
            toggleLayer("Canton", "cantons", "");
            toggleLayer("Marker", "markers", "");
            toggleLayer("H3000", "mountainsH", "");
            toggleLayer("P300", "mountainsP", "");
            function toggleLayer(name, id, state) {
              var link = document.createElement('a');
              link.href = '#';
              link.className = state;
              link.textContent = name;
              link.id = name;
              link.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                var visibility = map.getLayoutProperty(id, 'visibility');
                if (visibility === 'visible') {
                  map.setLayoutProperty(id, 'visibility', 'none');
                  this.className = '';
                } else {
                  this.className = 'active';
                  map.setLayoutProperty(id, 'visibility', 'visible');
                }
              };
              var layers = document.getElementById('menu');
              layers.appendChild(link);
            }

            //----------------------------------------------
            // Create the slider and add change actions
            var slider = document.createElement('input');
            slider.className = 'active';
            slider.setAttribute('type', 'range');
            slider.setAttribute('min', '3000');
            slider.setAttribute('max', '4000');
            slider.setAttribute('step', '100');
            slider.setAttribute('value', '3100');
            slider.setAttribute('list', 'tickmarks');
            slider.setAttribute('orient', 'vertical');
            var layers = document.getElementById('menu');
            layers.appendChild(slider);
            //var output = document.getElementById("demo");
            //output.innerHTML = slider.value;
            //slider.oninput = function() {
            //  output.innerHTML = this.value;
            //}
            slider.addEventListener('input', function(e) {
              var height = parseInt(e.target.value);
              // update the map
              map.setFilter('mountainsH', ['>=', ['number', ['get', 'height']], height]);
            });

      </script>
    </main>

    <footer class="footer">
        TrackMap: &copy; Tim Smith CC-BY-4.0
    </footer>
  </body>
</html>
